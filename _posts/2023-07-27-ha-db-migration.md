---
layout: post
title: "초단위 이하 중단시간으로 데이터베이스 마이그레이션하기"
slug: ha-db-migration
category: infra
---

데이터베이스는 아주 중요한 컴포넌트이지만, 정통적인 RDBMS의 경우는 단일 인스턴스로 동작하는 경우가 많기에 장애의 지점이 될 수도 있다. 그리고 장애의 경우뿐 아니라 여러가지 이유에서 데이터베이스를 옮기거나 마이그레이션해야할 일이 생긴다. 이 글에서는 중단시간이 거의 없이 데이터베이스를 이동하는 방법에 대한 고민을 적어본다.

일단 데이터베이스는 MySQL로 가정하고, 초당 10만건의 트랜잭션이 일어나는 서비스라고 가정해본다. 모든 요청은 선형화/직렬화가 가능하지만, 우리는 선형화가능성만 만족하면 된다고 가정하겠다. 또한 모든 요청의 순서는 여러가지 이유로 지연이나 뒤바뀜이 발생할 수 있으며 이는 분산 시스템에서 일반적인 상황이다. 데이터베이스에 대부분의 쿼리는 단일 혹은 몇개의 row에 대한 select이지만, 30%는 update, 5%는 insert라고 해보자. 나머지 5%는 복잡한 조회용 쿼리이며, 이러한 복잡한 조회용 쿼리는 inconsistency가 어느정도 허용된다. 전체 테이블은 30개정도이지만, 부하가 심한 테이블은 3개로 70%의 트랜잭션이 이 3개 테이블에서 일어난다. 나머지 20%의 트랜잭션은 테이블 5개에 적용된다. 마지막으로 이러한 워크로드에서 3년정도 운영했다고 가정해보자.

위 경우는 조금 현실적으로, 도전적으로 잡은 목표라고 할 수 있다.

1. 데이터베이스: MySQL(AWS RDS)
2. 트랜잭션: 초당 10만 건
3. 선형화: 모든 요청은 선형화 가능. 선형화 가능성만 만족하면 충분함.
4. 요청의 순서: 지연이나 순서 바뀜 가능 (분산 시스템의 특성)
5. 쿼리 분포:
- 대다수는 단일 혹은 몇개의 row에 대한 select
- 30%는 update
- 5%는 insert
- 나머지 5%는 복잡한 조회용 쿼리
6. 복잡한 조회용 쿼리: inconsistency 어느 정도 허용됨.
7. 테이블 수: 총 30개
8. 부하가 심한 테이블: 3개 (전체 트랜잭션의 70%가 이 3개 테이블에서 발생)
9. 중간 부하 테이블: 5개 (전체 트랜잭션의 20% 적용)
10. 운영 기간: 3년

데이터베이스에 대한 이야기를 했으니 서비스 배포에 대한 가정을 추가해보겠다. 서비스는 30~40개정도의 팟이 떠있는 서비스이며 k8s에 배포되어있다. 단일 코드 베이스로 운영되고 있으며 일주일에 2번정도 배포가 일어난다. 어플리케이션 서비스를 수정하는건 가능하지만, 대대적인 변화를 주는건 힘들다. 이러한 데이터베이스 마이그레이션이 중단없이 심리스하게 이루어지길 원한다.

이러한 가정들이 어느정도 현실적이기를 바라며, 다음 이야기를 시작해보겠다.

### first approach

가장 처음 접근할 수 있는건 failover기능이다. primary가 중단된 경우 secondary가 primary로 승격하고 장애를 빠르게 대응하는 방법이다. 그래서 failover버튼을 누르고 승격시키면 어떻게 될까?
